<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Karácsonyi húzás (Secret Santa) — egyszerű</title>
  <style>
    :root{font-family:Inter,system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial;}
    body{max-width:900px;margin:2rem auto;padding:1rem;line-height:1.45;color:#111}
    header{display:flex;align-items:center;gap:1rem}
    h1{margin:0;font-size:1.25rem}
    textarea{width:100%;height:160px;padding:0.6rem;font-size:0.95rem}
    label{font-weight:600}
    .controls{display:flex;gap:0.5rem;flex-wrap:wrap;margin:0.5rem 0}
    button{padding:0.5rem 0.8rem;border:0;background:#0366d6;color:white;border-radius:6px;cursor:pointer}
    button.secondary{background:#6c757d}
    .result{margin-top:1rem;border-radius:8px;padding:0.8rem;background:#f3f4f6}
    .pair{padding:0.4rem 0;border-bottom:1px dashed #ddd}
    .pair:last-child{border-bottom:none}
    small.hint{display:block;color:#666;margin-top:0.4rem}
    .error{color:#b00020;font-weight:600}
  </style>
</head>
<body>
  <header>
    <h1>Karácsonyi húzás (Secret Santa) — egyszerű weboldal</h1>
  </header>

  <p>Írd be a résztvevők neveit soronként (pl. 9 név). A <strong>Generálás</strong> gomb egy érvényes kiosztást készít úgy, hogy senki se kapjon önmagát.</p>

  <label for="names">Nevek (egy sor = egy személy):</label>
  <textarea id="names" placeholder="Pl.\nBogi
Panna
Laci
Matyi
Lori
kriszi
Dorci
Norbi</textarea>
  <div class="controls">
    <button id="generate">Generálás</button>
    <button class="secondary" id="shuffle">Újrarendezés</button>
    <button class="secondary" id="copy">Másolás vágólapra</button>
    <button class="secondary" id="download">Letöltés CSV</button>
    <button class="secondary" id="clear">Törlés</button>
  </div>
  <div id="message" class="error" aria-live="polite"></div>

  <div id="output" class="result" hidden>
    <h3>Eredmény</h3>
    <div id="pairs"></div>
    <small class="hint">Megjegyzés: minden generálás új kiosztást készít. Ha e-mail küldést szeretnél, jelezd, segítek hozzáadni.</small>
  </div>

<script>
// Derangement (nincs fixpont) készítése Fisher–Yates + ellenőrzés
function shuffle(array){
  for(let i = array.length -1; i>0; i--){
    const j = Math.floor(Math.random()*(i+1));
    [array[i], array[j]] = [array[j], array[i]];
  }
}

function makeDerangement(names){
  if(names.length === 1) return null;
  const maxAttempts = 5000; // nagyon ritka, hogy ennyi kell
  const callers = names.slice();
  for(let attempt=0; attempt<maxAttempts; attempt++){
    const receivers = names.slice();
    shuffle(receivers);
    // ha bárki önmagát kapja, vagy tiltott párost kap, próbálkozunk újra
    let ok = true;
    for(let i=0;i<callers.length;i++){
      if(callers[i] === receivers[i]){ ok = false; break; }
      if((callers[i]==="Matyi" && receivers[i]==="Dorci") || (callers[i]==="Dorci" && receivers[i]==="Matyi")) { ok=false; break; }
      if((callers[i]==="Panna" && receivers[i]==="Laci") || (callers[i]==="Laci" && receivers[i]==="Panna")) { ok=false; break; }
    }
    if(ok) return callers.map((c,i)=>({giver:c, receiver:receivers[i]}));
  }
  return null; // ha nem sikerül (nagyon ritka)
}

function parseNames(text){
  return text.split('\n').map(s=>s.trim()).filter(s=>s.length>0);
}

const namesEl = document.getElementById('names');
const generateBtn = document.getElementById('generate');
const shuffleBtn = document.getElementById('shuffle');
const pairsEl = document.getElementById('pairs');
const outputEl = document.getElementById('output');
const messageEl = document.getElementById('message');
const copyBtn = document.getElementById('copy');
const downloadBtn = document.getElementById('download');
const clearBtn = document.getElementById('clear');

let lastPairs = null;

function showMessage(text){ messageEl.textContent = text; }
function clearMessage(){ messageEl.textContent = ''; }

function renderPairs(pairs){
  pairsEl.innerHTML = '';
  pairs.forEach(p=>{
    const d = document.createElement('div');
    d.className = 'pair';
    d.textContent = p.giver + ' → ' + p.receiver;
    pairsEl.appendChild(d);
  });
  outputEl.hidden = false;
}

generateBtn.addEventListener('click', ()=>{
  clearMessage();
  const names = parseNames(namesEl.value);
  if(names.length < 2){ showMessage('Legalább 2 név szükséges.'); return; }
  const pairs = makeDerangement(names);
  if(!pairs){ showMessage('Nem sikerült érvényes kiosztást készíteni — próbáld újra.'); return; }
  lastPairs = pairs;
  renderPairs(pairs);
});

shuffleBtn.addEventListener('click', ()=>{
  if(!lastPairs){ showMessage('Előbb generálj egy kiosztást.'); return; }
  const names = lastPairs.map(p=>p.giver);
  const pairs = makeDerangement(names);
  if(!pairs){ showMessage('Nem sikerült újrarendezni.'); return; }
  lastPairs = pairs;
  renderPairs(pairs);
});

copyBtn.addEventListener('click', async ()=>{
  if(!lastPairs){ showMessage('Előbb generálj egy kiosztást.'); return; }
  const text = lastPairs.map(p=>p.giver + ',' + p.receiver).join('\n');
  try{
    await navigator.clipboard.writeText(text);
    showMessage('Kiosztás a vágólapra másolva.');
    setTimeout(clearMessage,2000);
  }catch(e){ showMessage('A másolás sikertelen.'); }
});

downloadBtn.addEventListener('click', ()=>{
  if(!lastPairs){ showMessage('Előbb generálj egy kiosztást.'); return; }
  const csv = 'Giver,Receiver\n' + lastPairs.map(p=> '"'+p.giver+'","'+p.receiver+'"').join('\n');
  const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'secret-santa.csv';
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
});

clearBtn.addEventListener('click', ()=>{
  namesEl.value = '';
  pairsEl.innerHTML = '';
  outputEl.hidden = true;
  lastPairs = null;
  clearMessage();
});

</script>
</body>
</html>
